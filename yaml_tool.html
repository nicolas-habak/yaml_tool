<html>
  <head>
    <style>
      TABLE.wrapper {
        width: 100%;
        height: 100%;
      }
      TD.lineNumbers {
        min-width: 20px;
      }
      TD.editor {
        width: 100%;
      }
      DIV.code {
        font-family: courier, courier new, serif;
        font-size: 12px;
      }
      DIV.wrapper {
        border: 1px #ccc solid;
        border-radius: 5px;
      }
      DIV.lineNumbers {
        color: #4286f4;
        border-right: 1px #ddd solid;
        height: 100%;
        text-align: right;
      }
      DIV.editor {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <input type="button" value="test" onclick="test()" />
    <div class="code wrapper">
      <table class="wrapper">
        <tr>
          <td class="lineNumbers">
            <div class="code lineNumbers">
            </div>
          </td>
          <td class="editor">
            <div class="code editor" contenteditable="true" onkeypress="codeKeyPress(event)" onkeydown="codeKeyDown(event)" onkeyup="codeKeyUp(event)">
            </div>
          </td>
        </tr>
      </table>
    </div>

    <script>
      let updated = false;
      function test() {
        let editor = document.querySelector('div.editor');
        let code = editor.innerText;
        let lines = code.split('\n');
        let output = "";
        let i = 1;
        for(let line of lines) {
          output += `line ${i++}: ${line}\n`;
        }
        alert(output);
      }

      let rsYaml = {
      }

      class Rule {
        constructor(style) {
          this.style = style || '';
        }

        applyRule(code) {
        }
      }

      class KeyWordRule extends Rule {
        constructor(keyWords, style) {
          super(style);
          this.keyWords = keyWords;
          this.regex = null;
          this.buildRegex();
        }
        buildRegex() {
          this.regex = new RegExp(`(?<=\\s)(${this.keyWords.join('|')})(?:\\s)`, 'gm');
        }
        applyRule(code) {
          return code.replace(this.regex, `<span style="${this.style}">$1</span>`);
        }
      }

      class RuleSet {
        constructor(rules) {
          this.rules = rules;
        }

        applyRule(text) {
            for(let rule of this.rules) {
              rule.applyRule(text);
            }
        }
      }

      let observer = new MutationObserver(divChange);
      let el = document.querySelector("div.editor");
      let config = {
        childList: true,
        subtree : true,
        attributes: false,
        characterData : true
      };

      //then actually do some observing
      observer.observe(el, config);

      function divChange () {
        if(!updated) {
          updateLineNumbers();
          updateSyntaxHighlighting(rsYaml);
        }
        updated = true;
      }

      function updateLineNumbers() {
        let divCode = document.querySelector('div.editor');
        let divLineNb = document.querySelector('div.lineNumbers');
        let lines = divCode.innerText.split('\n');
        let lineNb = lines.length;

        if(lines[lines.length-1] != "" || lineNb == 0)
          ++lineNb;
        let lineNumbers = "";

        for(let i = 1; i < lineNb; i++) {
          lineNumbers += i + '\r\n';
        }

        divLineNb.innerText = lineNumbers || 1;
      }

      function updateSyntaxHighlighting(ruleSet) {
        el.innerHtml = (new KeyWordRule(['int', 'string', 'bool'], 'color:blue')).applyRule(el.innerText);
        // https://www.w3schools.com/howto/howto_syntax_highlight.asp
      }

      function codeKeyDown(event) {
        updated = false;
        let divCode = document.querySelector('div.editor');
        switch (event.code) {
          case "Tab":
            let sel = document.getSelection();
            let start = sel.anchorOffset;
            let end = sel.focusOffset
            let pos = 0;

            console.log(`${start}, ${end}, ${pos}`)

            if(sel.type == "Range"){

                // console.log(sel.selectionStart + ', ' + sel.selectionEnd)
            } else {
              // console.log(sel.selectionStart + ', ' + sel.selectionEnd)
            }
            event.preventDefault();
            break;
          default:

        }
      }

      function codeKeyPress(event) {
        // console.log('kp');
        // console.log(event);
        // console.log('=========');
        // updateLineNumbers();
      }
      function codeKeyUp(event) {
        // console.log('ku');
        // console.log(event);
        // console.log('=========');
        // updateLineNumbers();
      }

      updateLineNumbers();
    </script>
  </body>
</html>
